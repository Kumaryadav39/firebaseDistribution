name: iOS Build & Distribute

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop

jobs:
  build-ios:
    runs-on: macos-14 # macos-14 runners have Xcode 15.4 and 16.0 preinstalled

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"

      - name: Show available Xcode versions
        run: ls /Applications | grep Xcode

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          # prefer 15.2 if available, else fallback to 15.4
          xcode-version: "15.2"

      - name: Flutter Clean
        run: flutter clean

      - name: Install Dependencies
        run: flutter pub get

      - name: Build iOS IPA (No Codesign)
        run: flutter build ipa --release --no-codesign

      - name: Distribute to Firebase App Distribution
        run: |
          firebase appdistribution:distribute build/ios/ipa/Runner.ipa \
            --app ${{ secrets.FIREBASE_APP_ID_IOS }} \
            --testers "kumar.nallakukkala@playerzpot.com" \
            --token ${{ secrets.FIREBASE_AUTH_TOKEN }}
